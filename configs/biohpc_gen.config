/* ----------------------------------------------------
 * Nextflow config file for the BioHPC Genomics Cluster
 * ----------------------------------------------------
 */

env {
  SLURM_CLUSTERS='biohpc_gen'
}

process {
  executor = 'slurm'
  queue = { task.memory <= 1536.GB ? (task.time > 2.d || task.memory > 384.GB ? 'biohpc_gen_production' : 'biohpc_gen_normal') : 'biohpc_gen_highmem' }
}

charliecloud {
  enabled = true
}

spack {
  enabled = true
}

process {

  withName: COLLECT_READS {
	  cpus = {4 * task.attempt }
	  memory = { 8.GB * task.attempt }
    time = { 1.h * task.attempt }
    container = 'quay.io/biocontainers/python:3.8.3'
  }

  withName: ALIGN {
	  cpus = {16 * task.attempt }
	  memory = { 16.GB * task.attempt }
    time = { 6.h * task.attempt }
    container = "gitlab.lrz.de:5005/beckerlab/container-playground/minimap2-samtools:697815eb"
  }

  withName: ALIGN_TO_BAM {
	  cpus = {16 * task.attempt }
	  memory = { 16.GB * task.attempt }
    time = { 6.h * task.attempt }
    container = "gitlab.lrz.de:5005/beckerlab/container-playground/minimap2-samtools:697815eb"
  }

  withName: ALIGN_SHORT_TO_BAM {
	  cpus = {16 * task.attempt }
	  memory = { 16.GB * task.attempt }
    time = { 6.h * task.attempt }
    container = "gitlab.lrz.de:5005/beckerlab/container-playground/minimap2-samtools:697815eb"
  }
  
  withName: SAMTOOLS_SORT {
	  cpus = {2 * task.attempt }
	  memory = { 4.GB * task.attempt }
    time = { 1.h * task.attempt }
    container = "quay.io/biocontainers/samtools:1.15.1--h1170115_0"
  }
  
  withName: SAMTOOLS_INDEX {
	  cpus = {2 * task.attempt }
	  memory = { 4.GB * task.attempt }
  	time = { 1.h * task.attempt }
    container = "quay.io/biocontainers/samtools:1.15.1--h1170115_0"
  }

  withName: SAMTOOLS_IDXSTATS {
	  cpus = {1 * task.attempt }
	  memory = { 4.GB * task.attempt }
  	time = { 4.h * task.attempt }
    container = "quay.io/biocontainers/samtools:1.15.1--h1170115_0"
  }

  withName: FLYE {
    cpus = {32 * task.attempt }
	  memory = { 96.GB * task.attempt }
  	time = { 12.h * task.attempt }
    container = "quay.io/biocontainers/flye:2.9--py39h6935b12_1"
  }

  withName: QUAST {
	  cpus = {16 * task.attempt }
	  memory = { 96.GB * task.attempt }
  	time = { 6.h * task.attempt }
    container = "quay.io/biocontainers/quast:5.2.0--py39pl5321h2add14b_1"
  } 

  withName: BUSCO {
	  cpus = {16 * task.attempt }
	  memory = { 16.GB * task.attempt }
  	time = { 2.h * task.attempt }
    container = "quay.io/biocontainers/busco:5.4.7--pyhdfd78af_0"
  }

  withName: PILON {
	  cpus = { 48 }
	  memory = { 96.GB }
  	time = { 18.h * task.attempt }
    container = "quay.io/biocontainers/pilon:1.24--hdfd78af_0"
  }

  withName: MEDAKA {
	  cpus = { 24 }
	  memory = { 48.GB * task.attempt }
  	time = { 6.h * task.attempt }
    container = "quay.io/biocontainers/medaka:1.8.0--py38hdaa7744_0"
  }

  withName: RAGTAG_SCAFFOLD {
	  cpus = { 48 }
	  memory = { 24.GB * task.attempt }
  	time = { 4.h * task.attempt }
    container = "quay.io/biocontainers/ragtag:2.1.0--pyhb7b1952_0"
  }

  withName: LIFTOFF {
	  cpus = { 16 }
	  memory = { 16.GB * task.attempt }
  	time = { 4.h * task.attempt }
    container = "quay.io/biocontainers/liftoff:1.6.3--pyhdfd78af_0"  
  }

  withName: AGAT_FILTER_BY_LENGTH {
    cpus = { 8 }
	  memory = { 16.GB * task.attempt }
  	time = { 1.h * task.attempt }
    container = "quay.io/biocontainers/agat:1.1.0--pl5321hdfd78af_1"  
  }

  withName: AGAT_EXTRACT_PROTEINS {
    cpus = { 8 }
	  memory = { 16.GB * task.attempt }
  	time = { 1.h * task.attempt }
    container = "quay.io/biocontainers/agat:1.1.0--pl5321hdfd78af_1" 
  }

  withName: INTERPROSCAN {
    cpus = { 8 }
	  memory = { 16.GB * task.attempt }
  	time = { 2.h * task.attempt }
    spack = 'interproscan@5.63-95.0'
  }

  withName: INTERPROSCAN_SUPERFAMILY {
    cpus = { 8 }
	  memory = { 16.GB * task.attempt }
  	time = { 2.h * task.attempt }
    spack = 'interproscan@5.63-95.0'
  }

  withName: INTERPROSCAN_PFAM {
    cpus = { 8 }
	  memory = { 16.GB * task.attempt }
  	time = { 2.h * task.attempt }
    spack = 'interproscan@5.63-95.0'
  }

  withName: BEDTOOLS_GETFASTA {
    cpus = { 8 }
	  memory = { 16.GB * task.attempt }
  	time = { 1.h * task.attempt }
    container = "staphb/bedtools:2.31.0"
  }

  withName: BEDTOOLS_CLUSTER {
    cpus = { 8 }
	  memory = { 16.GB * task.attempt }
  	time = { 1.h * task.attempt }
    container = "staphb/bedtools:2.31.0"
  }

  withName: BEDTOOLS_NR_CLUSTERS {
    cpus = { 8 }
	  memory = { 16.GB * task.attempt }
  	time = { 1.h * task.attempt }
    container = "staphb/bedtools:2.31.0"
  }

  withname: GENBLAST_G {
    cpus = { 16 }
	  memory = { 32.GB * task.attempt }
  	time = { 4.h * task.attempt }
    container = "quay.io/biocontainers/genblastg:1.38--h5b5514e_5"
  }

  withName: MEME {
    cpus = { 16 }
	  memory = { 32.GB * task.attempt }
  	time = { 4.h * task.attempt }
    container = "memesuite/memesuite:5.5.3"
  }

  withName: MAST {
    cpus = { 16 }
	  memory = { 32.GB * task.attempt }
  	time = { 4.h * task.attempt }
    container = "memesuite/memesuite:5.5.3"
  }

  withName: SEQTK_SUBSET {
    cpus = { 4 }
	  memory = { 8.GB * task.attempt }
  	time = { 1.h * task.attempt }
    container = "quay.io/biocontainers/seqtk:1.4--he4a0461_1"
  }

  withName: IPS2FPG {
    cpus = { 4 }
	  memory = { 8.GB * task.attempt }
  	time = { 1.h * task.attempt }
    container = "quay.io/biocontainers/python:3.9--1"
  }

  errorStrategy = { ( task.exitStatus == 140 || task.exitStatus == 137 ) ? 'retry' : 'finish' }
  maxRetries = 3
  maxErrors = '-1'
}

